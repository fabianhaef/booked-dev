{% extends "_layouts/cp" %}
{% import "_includes/forms" as forms %}

{% set title = availability.id ? "Verfügbarkeit bearbeiten" : "Neue Verfügbarkeit" %}
{% set crumbs = [
    { label: "Buchungen", url: url('booking') },
    { label: "Verfügbarkeit", url: url('booking/availability') },
    { label: title }
] %}

{% block content %}
    <form method="post" accept-charset="UTF-8">
        {{ csrfInput() }}
        <input type="hidden" name="action" value="booking/availability/save">
        {% if availability.id %}
            <input type="hidden" name="id" value="{{ availability.id }}">
        {% endif %}

        <div class="fields">
            <div class="field" id="title-field">
                <div class="heading">
                    <label for="title" class="required">Titel</label>
                </div>
                <div class="input ltr">
                    <input type="text" class="text fullwidth" id="title" name="title" value="{{ availability.title }}" required autofocus>
                </div>
                <div class="instructions">
                    <p>Ein eindeutiger Titel für diese Verfügbarkeit (z.B. "Montag Vormittag Yoga", "Sommerfest 2024")</p>
                </div>
            </div>

            <div class="field" id="availabilityType-field">
                <div class="heading">
                    <label id="availabilityType-label" for="availabilityType" class="required">Verfügbarkeitstyp</label>
                </div>
                <div class="input">
                    <div class="select fullwidth">
                        <select id="availabilityType" name="availabilityType" required>
                            <option value="recurring" {{ availability.availabilityType == 'recurring' ? 'selected' : '' }}>Wiederkehrend (Wochentag)</option>
                            <option value="event" {{ availability.availabilityType == 'event' ? 'selected' : '' }}>Einmaliges Event (spezifisches Datum)</option>
                        </select>
                    </div>
                </div>
                <div class="instructions">
                    <p>Wählen Sie, ob diese Verfügbarkeit wöchentlich wiederkehrt oder für ein spezifisches Event-Datum gilt.</p>
                </div>
            </div>

            <div class="field" id="sourceType-field">
                <div class="heading">
                    <label id="sourceType-label" for="sourceType" class="required">Verfügbarkeit für</label>
                </div>
                <div class="input">
                    <div class="select fullwidth">
                        <select id="sourceType" name="sourceType" required>
                            <option value="section" {{ availability.sourceType == 'section' ? 'selected' : '' }}>Sektion</option>
                            <option value="entry" {{ availability.sourceType == 'entry' ? 'selected' : '' }}>Eintrag</option>
                        </select>
                    </div>
                </div>
                <div class="instructions">
                    <p>Wählen Sie aus, ob diese Verfügbarkeit für eine ganze Sektion oder einen bestimmten Eintrag gilt.</p>
                </div>
            </div>

            <div class="field" id="description-field">
                <div class="heading">
                    <label id="description-label" for="description">Beschreibung</label>
                </div>
                <div class="input">
                    <textarea class="text fullwidth" id="description" name="description" rows="3">{{ availability.description }}</textarea>
                </div>
                <div class="instructions">
                    <p>Optionale Beschreibung für diese Verfügbarkeit.</p>
                </div>
            </div>

            <div class="field" id="sourceSection-field" style="{{ availability.sourceType == 'entry' ? 'display:none;' : '' }}">
                <div class="heading">
                    <label id="sourceSection-label" for="sourceHandle">Sektion</label>
                </div>
                <div class="input">
                    <div class="select fullwidth">
                        <select id="sourceHandle" name="sourceHandle">
                            <option value="">Sektion auswählen</option>
                            {% for section in craft.app.entries.allSections() %}
                                <option value="{{ section.handle }}" {{ availability.sourceHandle == section.handle ? 'selected' : '' }}>
                                    {{ section.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>

            <div class="field" id="sourceEntry-field" style="{{ availability.sourceType == 'section' ? 'display:none;' : '' }}">
                <div class="heading">
                    <label id="sourceEntry-label" for="sourceId">Eintrag</label>
                </div>
                <div class="input">
                    {{ forms.elementSelect({
                        id: 'sourceId',
                        name: 'sourceId',
                        elementType: 'craft\\elements\\Entry',
                        elements: availability.sourceId ? [craft.entries.id(availability.sourceId).one()] : [],
                        limit: 1,
                        selectionLabel: 'Eintrag auswählen'
                    }) }}
                </div>
                <div class="instructions">
                    <p>Wählen Sie den spezifischen Eintrag aus, für den diese Verfügbarkeit gilt.</p>
                </div>
            </div>

            <div class="field" id="dayOfWeek-field" style="{{ availability.availabilityType == 'event' ? 'display:none;' : '' }}">
                <div class="heading">
                    <label id="dayOfWeek-label" class="required">Wochentag{{ availability.id ? '' : 'e' }}</label>
                </div>
                {% if availability.id %}
                    {# Single day selector when editing #}
                    <div class="input">
                        <div class="select fullwidth">
                            <select id="dayOfWeek" name="dayOfWeek">
                                <option value="">Tag auswählen</option>
                                {% for value, label in days %}
                                    <option value="{{ value }}" {{ availability.dayOfWeek == value ? 'selected' : '' }}>{{ label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="instructions">
                        <p>Wochentag für diese Verfügbarkeit.</p>
                    </div>
                {% else %}
                    {# Multiple day checkboxes when creating new #}
                    <div class="input">
                        <div class="checkboxgroup">
                            {% for value, label in days %}
                                <label>
                                    <input type="checkbox" name="days[]" value="{{ value }}">
                                    {{ label }}
                                </label>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="instructions">
                        <p>Wählen Sie einen oder mehrere Wochentage. Für jeden Tag wird eine separate Verfügbarkeit mit denselben Zeiten erstellt.</p>
                    </div>
                    <div id="quick-select-days" style="margin-top: 12px; padding: 12px; background: #f0f0f0; border-radius: 4px;">
                        <p><strong>Schnellauswahl:</strong></p>
                        <button type="button" class="btn small" onclick="selectWeekdays()">Wochentage</button>
                        <button type="button" class="btn small" onclick="selectWeekends()">Wochenende</button>
                        <button type="button" class="btn small" onclick="selectAllDays()">Alle Tage</button>
                        <button type="button" class="btn small" onclick="selectNoDays()">Keine</button>
                    </div>
                {% endif %}
                {% if availability.hasErrors('dayOfWeek') %}
                    <ul class="errors">
                        {% for error in availability.getErrors('dayOfWeek') %}
                            <li>{{ error }}</li>
                        {% endfor %}
                    </ul>
                {% endif %}
            </div>

            <div class="field" id="eventDates-field" style="{{ availability.availabilityType == 'recurring' ? 'display:none;' : '' }}">
                <div class="heading">
                    <label id="eventDates-label">Event-Termine</label>
                </div>
                <div class="instructions">
                    <p>Fügen Sie ein oder mehrere Event-Termine mit ihren jeweiligen Zeiten hinzu.</p>
                </div>

                <div id="eventDates-container">
                    {% set eventDates = availability.eventDates %}
                    {% if eventDates|length > 0 %}
                        {% for eventDate in eventDates %}
                            <div class="event-date-row" style="display: flex; gap: 10px; margin-bottom: 10px; align-items: flex-start;">
                                <div style="flex: 1;">
                                    <input class="text fullwidth" type="date" name="eventDates[{{ loop.index0 }}][date]" value="{{ eventDate.eventDate }}" required>
                                </div>
                                <div style="flex: 1;">
                                    <input class="text fullwidth" type="time" name="eventDates[{{ loop.index0 }}][startTime]" value="{{ eventDate.startTime }}" required placeholder="Startzeit">
                                </div>
                                <div style="flex: 1;">
                                    <input class="text fullwidth" type="time" name="eventDates[{{ loop.index0 }}][endTime]" value="{{ eventDate.endTime }}" required placeholder="Endzeit">
                                </div>
                                <button type="button" class="btn small remove-event-date" style="flex-shrink: 0;">Entfernen</button>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="event-date-row" style="display: flex; gap: 10px; margin-bottom: 10px; align-items: flex-start;">
                            <div style="flex: 1;">
                                <input class="text fullwidth" type="date" name="eventDates[0][date]" required>
                            </div>
                            <div style="flex: 1;">
                                <input class="text fullwidth" type="time" name="eventDates[0][startTime]" required placeholder="Startzeit">
                            </div>
                            <div style="flex: 1;">
                                <input class="text fullwidth" type="time" name="eventDates[0][endTime]" required placeholder="Endzeit">
                            </div>
                            <button type="button" class="btn small remove-event-date" style="flex-shrink: 0;">Entfernen</button>
                        </div>
                    {% endif %}
                </div>

                <button type="button" id="add-event-date" class="btn" style="margin-top: 10px;">+ Weiteren Termin hinzufügen</button>
            </div>

            <div class="flex">
                <div class="field" id="startTime-field">
                    <div class="heading">
                        <label id="startTime-label" for="startTime" class="required">Startzeit</label>
                    </div>
                    <div class="input">
                        <input class="text fullwidth" type="time" id="startTime" name="startTime" 
                               value="{{ availability.startTime }}" required>
                    </div>
                    {% if availability.hasErrors('startTime') %}
                        <ul class="errors">
                            {% for error in availability.getErrors('startTime') %}
                                <li>{{ error }}</li>
                            {% endfor %}
                        </ul>
                    {% endif %}
                </div>

                <div class="field" id="endTime-field">
                    <div class="heading">
                        <label id="endTime-label" for="endTime" class="required">Endzeit</label>
                    </div>
                    <div class="input">
                        <input class="text fullwidth" type="time" id="endTime" name="endTime" 
                               value="{{ availability.endTime }}" required>
                    </div>
                    {% if availability.hasErrors('endTime') %}
                        <ul class="errors">
                            {% for error in availability.getErrors('endTime') %}
                                <li>{{ error }}</li>
                            {% endfor %}
                        </ul>
                    {% endif %}
                </div>
            </div>

            <div class="field" id="variations-field" style="margin-top: 24px;">
                <div class="heading">
                    <label id="variations-label" for="variations">Varianten</label>
                </div>
                <div class="input">
                    {{ forms.elementSelect({
                        id: 'variations',
                        name: 'variationIds',
                        elementType: 'modules\\booking\\elements\\BookingVariation',
                        elements: availability.variations,
                        limit: null,
                        selectionLabel: 'Variante hinzufügen'
                    }) }}
                </div>
                <div class="instructions">
                    <p>Wählen Sie eine oder mehrere Varianten aus, die für diese Verfügbarkeit buchbar sein sollen. Die Slot-Dauer und Pufferzeit werden von der ausgewählten Variante übernommen.</p>
                </div>
            </div>

            <div class="field" id="isActive-field">
                <input type="hidden" name="isActive" value="0">
                <label>
                    <input type="checkbox" id="isActive" name="isActive" value="1" 
                           {{ availability.isActive ? 'checked' : '' }}>
                    Aktiv
                </label>
                <div class="instructions">
                    <p>Deaktivieren Sie diese Option, um diese Verfügbarkeitszeit vorübergehend zu deaktivieren, ohne sie zu löschen.</p>
                </div>
            </div>
        </div>

        <div class="buttons">
            <button type="submit" class="btn submit">{{ availability.id ? 'Aktualisieren' : 'Erstellen' }}</button>
            <a class="btn" href="{{ url('booking/availability') }}">Abbrechen</a>
        </div>
    </form>

    {% js %}
        // Quick select functions for multiple days
        function selectWeekdays() {
            const checkboxes = document.querySelectorAll('input[name="days[]"]');
            checkboxes.forEach((cb, index) => {
                cb.checked = index >= 0 && index <= 4; // Monday to Friday
            });
        }

        function selectWeekends() {
            const checkboxes = document.querySelectorAll('input[name="days[]"]');
            checkboxes.forEach((cb, index) => {
                cb.checked = index === 6 || index === 7; // 
            });
        }

        function selectAllDays() {
            const checkboxes = document.querySelectorAll('input[name="days[]"]');
            checkboxes.forEach(cb => cb.checked = true);
        }

        function selectNoDays() {
            const checkboxes = document.querySelectorAll('input[name="days[]"]');
            checkboxes.forEach(cb => cb.checked = false);
        }

        // Toggle between recurring and event availability types
        function toggleAvailabilityType() {
            const availabilityType = document.getElementById('availabilityType').value;
            const dayOfWeekField = document.getElementById('dayOfWeek-field');
            const dayOfWeekSelect = document.getElementById('dayOfWeek');
            const eventDatesField = document.getElementById('eventDates-field');
            const recurringTimesField = document.getElementById('startTime-field').closest('.flex');
            const startTimeInput = document.getElementById('startTime');
            const endTimeInput = document.getElementById('endTime');

            if (availabilityType === 'recurring') {
                dayOfWeekField.style.display = '';
                eventDatesField.style.display = 'none';
                recurringTimesField.style.display = '';

                // Enable recurring fields
                if (dayOfWeekSelect) {
                    dayOfWeekSelect.required = true;
                }
                startTimeInput.required = true;
                endTimeInput.required = true;

                // Disable event date fields
                const eventDateInputs = document.querySelectorAll('#eventDates-container input');
                eventDateInputs.forEach(input => input.required = false);
            } else {
                dayOfWeekField.style.display = 'none';
                eventDatesField.style.display = '';
                recurringTimesField.style.display = 'none';

                // Disable recurring fields
                if (dayOfWeekSelect) {
                    dayOfWeekSelect.required = false;
                }
                startTimeInput.required = false;
                endTimeInput.required = false;

                // Enable event date fields
                const eventDateInputs = document.querySelectorAll('#eventDates-container input');
                eventDateInputs.forEach(input => input.required = true);
            }
        }

        document.getElementById('availabilityType').addEventListener('change', toggleAvailabilityType);

        // Toggle between section and entry fields based on sourceType
        document.getElementById('sourceType').addEventListener('change', function() {
            const sourceType = this.value;
            const sectionField = document.getElementById('sourceSection-field');
            const entryField = document.getElementById('sourceEntry-field');

            if (sourceType === 'section') {
                sectionField.style.display = '';
                entryField.style.display = 'none';
                // Clear entry selection
                document.getElementById('sourceId').value = '';
            } else {
                sectionField.style.display = 'none';
                entryField.style.display = '';
                // Clear section selection
                document.getElementById('sourceHandle').value = '';
            }
        });

        // Add event date row
        let eventDateIndex = {{ eventDates|length > 0 ? eventDates|length : 1 }};
        document.getElementById('add-event-date').addEventListener('click', function() {
            const container = document.getElementById('eventDates-container');
            const row = document.createElement('div');
            row.className = 'event-date-row';
            row.style.cssText = 'display: flex; gap: 10px; margin-bottom: 10px; align-items: flex-start;';
            row.innerHTML = `
                <div style="flex: 1;">
                    <input class="text fullwidth" type="date" name="eventDates[${eventDateIndex}][date]" required>
                </div>
                <div style="flex: 1;">
                    <input class="text fullwidth" type="time" name="eventDates[${eventDateIndex}][startTime]" required placeholder="Startzeit">
                </div>
                <div style="flex: 1;">
                    <input class="text fullwidth" type="time" name="eventDates[${eventDateIndex}][endTime]" required placeholder="Endzeit">
                </div>
                <button type="button" class="btn small remove-event-date" style="flex-shrink: 0;">Entfernen</button>
            `;
            container.appendChild(row);
            eventDateIndex++;
        });

        // Remove event date row
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('remove-event-date')) {
                const container = document.getElementById('eventDates-container');
                if (container.querySelectorAll('.event-date-row').length > 1) {
                    e.target.closest('.event-date-row').remove();
                } else {
                    alert('Sie müssen mindestens einen Event-Termin haben.');
                }
            }
        });

        // Initialize on page load
        toggleAvailabilityType();
    {% endjs %}

    {% css %}
        .checkboxgroup {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 8px;
        }

        .checkboxgroup label {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: #f7f7f7;
            border-radius: 4px;
            cursor: pointer;
        }

        .checkboxgroup label:hover {
            background: #e8f4fd;
        }
    {% endcss %}
{% endblock %}
