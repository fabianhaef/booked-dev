{% extends "_layouts/cp" %}
{% import "_includes/forms" as forms %}

{% set selectedSubnavItem = 'employees' %}
{% set title = employee.id ? 'Edit Employee'|t('booked') : 'New Employee'|t('booked') %}
{% set crumbs = [
    { label: 'Booked'|t('booked'), url: url('booked/employees') },
    { label: 'Employees'|t('booked'), url: url('booked/employees') },
    { label: title }
] %}

{% set fullPageForm = true %}

{% block content %}
    <input type="hidden" name="action" value="booked/cp/employees/save">
    {% if employee.id %}
        <input type="hidden" name="elementId" value="{{ employee.id }}">
    {% endif %}

    <div id="fields">
        {{ forms.lightswitchField({
            label: 'Enabled'|t('app'),
            id: 'enabled',
            name: 'enabled',
            on: employee.enabled ?? true
        }) }}

        {{ forms.textField({
            label: 'Title'|t('app'),
            id: 'title',
            name: 'title',
            value: employee.title,
            required: true,
            autofocus: true,
            errors: employee.getErrors('title')
        }) }}

        {{ forms.selectField({
            label: 'User'|t('booked'),
            id: 'userId',
            name: 'userId',
            options: [{ value: '', label: 'Select User'|t('booked') }]|merge(users|map(u => { value: u.id, label: u.name ?? u.email })),
            value: employee.userId,
            errors: employee.getErrors('userId'),
            instructions: 'Link this employee to a Craft user account'
        }) }}

        {{ forms.elementSelectField({
            label: 'Location'|t('booked'),
            id: 'locationId',
            name: 'locationId',
            elementType: 'fabian\\booked\\elements\\Location',
            elements: employee.locationId and employee.getLocation() ? [employee.getLocation()] : [],
            limit: 1,
            errors: employee.getErrors('locationId'),
            instructions: 'Primary location for this employee'
        }) }}

        {% set assignedServices = [] %}
        {% if employee.id %}
            {% for serviceId in employee.getServiceIds() %}
                {% set service = craft.app.elements.getElementById(serviceId, 'fabian\\booked\\elements\\Service') %}
                {% if service %}
                    {% set assignedServices = assignedServices|merge([service]) %}
                {% endif %}
            {% endfor %}
        {% endif %}

        {{ forms.elementSelectField({
            label: 'Services'|t('booked'),
            id: 'services',
            name: 'services',
            elementType: 'fabian\\booked\\elements\\Service',
            elements: assignedServices,
            limit: null,
            sources: '*',
            errors: employee.getErrors('services'),
            instructions: 'Select which services this employee can perform'
        }) }}

        {% if employee.id %}
            <hr>
            <h3>{{ 'Calendar Synchronization'|t('booked') }}</h3>
            
            <div class="field">
                <div class="heading">
                    <label>{{ 'Google Calendar'|t('booked') }}</label>
                </div>
                <div class="input">
                    {% if googleConnected %}
                        <span class="status green"></span> {{ 'Connected'|t('booked') }}
                        <a href="{{ url('booked/calendar/connect', { employeeId: employee.id, provider: 'google' }) }}" class="btn small">{{ 'Reconnect'|t('booked') }}</a>
                    {% else %}
                        <a href="{{ url('booked/calendar/connect', { employeeId: employee.id, provider: 'google' }) }}" class="btn small submit">{{ 'Connect Google Calendar'|t('booked') }}</a>
                    {% endif %}
                </div>
            </div>

            <div class="field">
                <div class="heading">
                    <label>{{ 'Microsoft Outlook'|t('booked') }}</label>
                </div>
                <div class="input">
                    {% if outlookConnected %}
                        <span class="status green"></span> {{ 'Connected'|t('booked') }}
                        <a href="{{ url('booked/calendar/connect', { employeeId: employee.id, provider: 'outlook' }) }}" class="btn small">{{ 'Reconnect'|t('booked') }}</a>
                    {% else %}
                        <a href="{{ url('booked/calendar/connect', { employeeId: employee.id, provider: 'outlook' }) }}" class="btn small submit">{{ 'Connect Outlook Calendar'|t('booked') }}</a>
                    {% endif %}
                </div>
            </div>
        {% endif %}
    </div>
{% endblock %}

