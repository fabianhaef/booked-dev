{% extends "_layouts/cp" %}
{% import "_includes/forms" as forms %}

{% set selectedSubnavItem = 'employees' %}
{% set title = employee.id ? 'Edit Employee'|t('booked') : 'New Employee'|t('booked') %}
{% set crumbs = [
    { label: 'Booked'|t('booked'), url: url('booked/employees') },
    { label: 'Employees'|t('booked'), url: url('booked/employees') },
    { label: title }
] %}

{% set fullPageForm = true %}

{% block content %}
    <input type="hidden" name="action" value="booked/cp/employees/save">
    {% if employee.id %}
        <input type="hidden" name="elementId" value="{{ employee.id }}">
    {% endif %}

    <div id="fields">
        {{ forms.lightswitchField({
            label: 'Enabled'|t('app'),
            id: 'enabled',
            name: 'enabled',
            on: employee.enabled ?? true
        }) }}

        {{ forms.textField({
            label: 'Title'|t('app'),
            id: 'title',
            name: 'title',
            value: employee.title,
            required: true,
            autofocus: true,
            errors: employee.getErrors('title')
        }) }}

        {% set selectedUser = employee.userId ? craft.users.id(employee.userId).one() : null %}
        {{ forms.elementSelectField({
            label: 'User'|t('booked'),
            id: 'userId',
            name: 'userId',
            elementType: 'craft\\elements\\User',
            elements: selectedUser ? [selectedUser] : [],
            limit: 1,
            viewMode: 'large',
            errors: employee.getErrors('userId'),
        }) }}

        {# JavaScript to disable already-assigned users in the modal #}
        {% js %}
            (function() {
                const assignedUserIds = {{ assignedUserIds|json_encode|raw }};
                if (assignedUserIds.length === 0) return;

                // Listen for when the element selector modal opens
                Garnish.on(Craft.BaseElementSelectInput, 'selectElements', function(ev) {
                    if (ev.target.$input && ev.target.$input.attr('id') === 'userId') {
                        setTimeout(function() {
                            const modal = ev.target.elementSelect.modal;
                            if (modal && modal.$container) {
                                // Find all user elements in the modal
                                modal.$container.find('.element').each(function() {
                                    const $element = $(this);
                                    const elementId = parseInt($element.attr('data-id'));

                                    if (assignedUserIds.includes(elementId)) {
                                        $element.addClass('disabled');
                                        $element.css('opacity', '0.5');
                                        $element.css('cursor', 'not-allowed');

                                        // Prevent selection
                                        $element.on('click', function(e) {
                                            e.preventDefault();
                                            e.stopPropagation();
                                            Craft.cp.displayNotice('This user is already assigned to another employee.');
                                            return false;
                                        });
                                    }
                                });
                            }
                        }, 100);
                    }
                });
            })();
        {% endjs %}

        {{ forms.elementSelectField({
            label: 'Location'|t('booked'),
            id: 'locationId',
            name: 'locationId',
            elementType: 'fabian\\booked\\elements\\Location',
            elements: employee.locationId and employee.getLocation() ? [employee.getLocation()] : [],
            limit: 1,
            errors: employee.getErrors('locationId'),
        }) }}

        {% set assignedServices = [] %}
        {% if employee.id %}
            {% for serviceId in employee.getServiceIds() %}
                {% set service = craft.app.elements.getElementById(serviceId, 'fabian\\booked\\elements\\Service') %}
                {% if service %}
                    {% set assignedServices = assignedServices|merge([service]) %}
                {% endif %}
            {% endfor %}
        {% endif %}

        {{ forms.elementSelectField({
            label: 'Services'|t('booked'),
            id: 'services',
            name: 'services',
            elementType: 'fabian\\booked\\elements\\Service',
            elements: assignedServices,
            limit: null,
            sources: '*',
            errors: employee.getErrors('services'),
            instructions: 'Select which services this employee can perform'
        }) }}

        {% if employee.id %}
            <hr>
            <h3>{{ 'Working Hours'|t('booked') }}</h3>

            {% set schedules = craft.app.elements.createElement('fabian\\booked\\elements\\Schedule')
                .find()
                .employeeId(employee.id)
                .orderBy('startTime asc')
                .all() %}

            {% if schedules|length > 0 %}
                <div class="field">
                    <div class="input">
                        <table class="data fullwidth">
                            <thead>
                                <tr>
                                    <th>{{ 'Schedule'|t('booked') }}</th>
                                    <th>{{ 'Days'|t('booked') }}</th>
                                    <th>{{ 'Time'|t('booked') }}</th>
                                    <th>{{ 'Status'|t('app') }}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for schedule in schedules %}
                                    <tr>
                                        <td>
                                            <a href="{{ schedule.cpEditUrl }}">{{ schedule.title }}</a>
                                        </td>
                                        <td>{{ schedule.getDaysName() }}</td>
                                        <td>{{ schedule.startTime }} - {{ schedule.endTime }}</td>
                                        <td>
                                            {% if schedule.enabled %}
                                                <span class="status green"></span> {{ 'Enabled'|t('app') }}
                                            {% else %}
                                                <span class="status"></span> {{ 'Disabled'|t('app') }}
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <p class="light">
                        {{ 'Schedules are managed separately.'|t('booked') }}
                        <a href="{{ url('booked/schedules') }}">{{ 'Manage Schedules'|t('booked') }}</a>
                    </p>
                </div>
            {% else %}
                <div class="field">
                    <p class="light">
                        {{ 'No schedules assigned to this employee yet.'|t('booked') }}
                        <a href="{{ url('booked/schedules/new') }}">{{ 'Create Schedule'|t('booked') }}</a>
                    </p>
                </div>
            {% endif %}
        {% endif %}

        {% if employee.id %}
            <hr>
            <h3>{{ 'Calendar Synchronization'|t('booked') }}</h3>
            
            <div class="field">
                <div class="heading">
                    <label>{{ 'Google Calendar'|t('booked') }}</label>
                </div>
                <div class="input">
                    {% if googleConnected %}
                        <span class="status green"></span> {{ 'Connected'|t('booked') }}
                        <a href="{{ url('booked/calendar/connect', { employeeId: employee.id, provider: 'google' }) }}" class="btn small">{{ 'Reconnect'|t('booked') }}</a>
                    {% else %}
                        <a href="{{ url('booked/calendar/connect', { employeeId: employee.id, provider: 'google' }) }}" class="btn small submit">{{ 'Connect Google Calendar'|t('booked') }}</a>
                    {% endif %}
                </div>
            </div>

            <div class="field">
                <div class="heading">
                    <label>{{ 'Microsoft Outlook'|t('booked') }}</label>
                </div>
                <div class="input">
                    {% if outlookConnected %}
                        <span class="status green"></span> {{ 'Connected'|t('booked') }}
                        <a href="{{ url('booked/calendar/connect', { employeeId: employee.id, provider: 'outlook' }) }}" class="btn small">{{ 'Reconnect'|t('booked') }}</a>
                    {% else %}
                        <a href="{{ url('booked/calendar/connect', { employeeId: employee.id, provider: 'outlook' }) }}" class="btn small submit">{{ 'Connect Outlook Calendar'|t('booked') }}</a>
                    {% endif %}
                </div>
            </div>
        {% endif %}
    </div>
{% endblock %}

