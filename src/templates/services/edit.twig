{% extends "_layouts/cp" %}
{% import "_includes/forms" as forms %}

{% set selectedSubnavItem = 'services' %}
{% set title = service.id ? 'Edit Service'|t('booked') : 'New Service'|t('booked') %}
{% set crumbs = [
    { label: 'Booked'|t('booked'), url: url('booked/services') },
    { label: 'Services'|t('booked'), url: url('booked/services') },
    { label: title }
] %}

{% set fullPageForm = true %}

{% block content %}
    <input type="hidden" name="action" value="booked/cp/services/save">
    {% if service.id %}
        <input type="hidden" name="elementId" value="{{ service.id }}">
    {% endif %}

    <div id="fields">
        {{ forms.textField({
            label: 'Title'|t('app'),
            id: 'title',
            name: 'title',
            value: service.title,
            required: true,
            autofocus: true,
            errors: service.getErrors('title')
        }) }}

        <div class="flex" style="gap: 1rem;">
            <div style="flex: 1;">
                {{ forms.textField({
                    label: 'Duration (minutes)'|t('booked'),
                    id: 'duration',
                    name: 'duration',
                    type: 'number',
                    value: service.duration,
                    errors: service.getErrors('duration'),
                    instructions: 'Service duration in minutes'
                }) }}
            </div>

            <div style="flex: 1;">
                {{ forms.textField({
                    label: 'Price'|t('booked'),
                    id: 'price',
                    name: 'price',
                    type: 'number',
                    step: '0.01',
                    value: service.price,
                    errors: service.getErrors('price'),
                    instructions: 'Service price'
                }) }}
            </div>
        </div>

        <div class="flex" style="gap: 1rem; margin-top: 1.5rem;">
            <div style="flex: 1;">
                {{ forms.textField({
                    label: 'Buffer Before (minutes)'|t('booked'),
                    id: 'bufferBefore',
                    name: 'bufferBefore',
                    type: 'number',
                    value: service.bufferBefore,
                    errors: service.getErrors('bufferBefore'),
                    instructions: 'Buffer time before service starts'
                }) }}
            </div>

            <div style="flex: 1;">
                {{ forms.textField({
                    label: 'Buffer After (minutes)'|t('booked'),
                    id: 'bufferAfter',
                    name: 'bufferAfter',
                    type: 'number',
                    value: service.bufferAfter,
                    errors: service.getErrors('bufferAfter'),
                    instructions: 'Buffer time after service ends'
                }) }}
            </div>
        </div>

        {{ forms.lightswitchField({
            label: 'Enabled'|t('app'),
            id: 'enabled',
            name: 'enabled',
            on: service.enabled ?? true
        }) }}

        {% set settings = craft.booked.getSettings() %}
        {% if settings.enableVirtualMeetings %}
            <hr>

            {{ forms.selectField({
                label: 'Virtual Meeting Provider'|t('booked'),
                id: 'virtualMeetingProvider',
                name: 'virtualMeetingProvider',
                options: [
                    { label: 'None'|t('booked'), value: '' },
                    { label: 'Zoom'|t('booked'), value: 'zoom' },
                    { label: 'Google Meet'|t('booked'), value: 'google_meet' }
                ],
                value: service.virtualMeetingProvider,
                errors: service.getErrors('virtualMeetingProvider'),
                instructions: 'Select the virtual meeting provider for this service.'|t('booked')
            }) }}
        {% endif %}

        {# Service Extras #}
        {% set allExtras = craft.booked.serviceExtra.getAllExtras() %}
        {% if allExtras|length %}
            <hr>

            <h2>{{ 'Service Extras'|t('booked') }}</h2>
            <p class="instructions">{{ 'Select which extras should be available for this service. Leave all unchecked to make all extras available.'|t('booked') }}</p>

            {% if service.id %}
                {% set serviceExtras = craft.booked.serviceExtra.getExtrasForService(service.id, false) %}
                {% set assignedExtraIds = serviceExtras|map(e => e.id) %}
            {% else %}
                {% set assignedExtraIds = [] %}
            {% endif %}

            <div class="extras-checkboxes">
                {% for extra in allExtras %}
                    <label class="extra-checkbox-item">
                        <input
                            type="checkbox"
                            name="extras[]"
                            value="{{ extra.id }}"
                            {% if extra.id in assignedExtraIds %}checked{% endif %}
                        >
                        <div class="extra-info">
                            <strong>{{ extra.name }}</strong>
                            {% if extra.description %}
                                <span class="light">{{ extra.description|slice(0, 100) }}{% if extra.description|length > 100 %}...{% endif %}</span>
                            {% endif %}
                            <div class="extra-meta">
                                <span class="price">{{ extra.price|number(2) }} {{ craft.app.locale.getCurrencySymbol(craft.booked.currency) }}</span>
                                {% if extra.duration > 0 %}
                                    <span class="duration">+{{ extra.duration }} min</span>
                                {% endif %}
                                {% if extra.isRequired %}
                                    <span class="badge required">Required</span>
                                {% endif %}
                                {% if not extra.enabled %}
                                    <span class="badge disabled">Disabled</span>
                                {% endif %}
                            </div>
                        </div>
                    </label>
                {% endfor %}
            </div>

            <p class="light" style="margin-top: 10px;">
                <a href="{{ url('booked/service-extras') }}" target="_blank">{{ 'Manage Service Extras'|t('booked') }}</a>
            </p>
        {% else %}
            <hr>
            <div class="zilch" style="padding: 20px; text-align: center;">
                <p>{{ 'No service extras exist yet.'|t('booked') }}</p>
                <a href="{{ url('booked/service-extras/new') }}" class="btn">{{ 'Create your first extra'|t('booked') }}</a>
            </div>
        {% endif %}
    </div>
{% endblock %}

{% css %}
.extras-checkboxes {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-top: 12px;
}

.extra-checkbox-item {
    display: flex;
    align-items: flex-start;
    padding: 12px;
    background: #f9fafb;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
}

.extra-checkbox-item:hover {
    background: #ffffff;
    border-color: #3b82f6;
}

.extra-checkbox-item input[type="checkbox"] {
    margin-right: 12px;
    margin-top: 3px;
    flex-shrink: 0;
}

.extra-info {
    flex: 1;
}

.extra-info strong {
    display: block;
    margin-bottom: 4px;
    color: #111827;
}

.extra-info .light {
    display: block;
    color: #6b7280;
    font-size: 13px;
    margin-bottom: 6px;
}

.extra-meta {
    display: flex;
    gap: 12px;
    align-items: center;
    font-size: 13px;
    margin-top: 6px;
}

.extra-meta .price {
    color: #3b82f6;
    font-weight: 600;
}

.extra-meta .duration {
    color: #6b7280;
}

.extra-meta .badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
}

.extra-meta .badge.required {
    background: #fef3c7;
    color: #92400e;
}

.extra-meta .badge.disabled {
    background: #f3f4f6;
    color: #6b7280;
}
{% endcss %}

