{% extends "_layouts/cp" %}
{% import "_includes/forms" as forms %}

{% set selectedSubnavItem = 'services' %}
{% set title = service.id ? 'Edit Service'|t('booked') : 'New Service'|t('booked') %}
{% set crumbs = [
    { label: 'Booked'|t('booked'), url: url('booked/services') },
    { label: 'Services'|t('booked'), url: url('booked/services') },
    { label: title }
] %}

{% set fullPageForm = true %}

{% block content %}
    <input type="hidden" name="action" value="booked/cp/services/save">
    {% if service.id %}
        <input type="hidden" name="elementId" value="{{ service.id }}">
    {% endif %}

    <div id="fields">
        {{ forms.lightswitchField({
            label: 'Enabled'|t('app'),
            id: 'enabled',
            name: 'enabled',
            on: service.enabled ?? true
        }) }}

        {{ forms.textField({
            label: 'Title'|t('app'),
            id: 'title',
            name: 'title',
            value: service.title,
            required: true,
            autofocus: true,
            errors: service.getErrors('title')
        }) }}

        <div class="flex" style="gap: 1rem;">
            <div style="flex: 1;">
                {{ forms.textField({
                    label: 'Duration (minutes)'|t('booked'),
                    id: 'duration',
                    name: 'duration',
                    type: 'number',
                    value: service.duration,
                    errors: service.getErrors('duration'),
                    instructions: 'Service duration in minutes'|t('booked')
                }) }}
            </div>

            <div style="flex: 1;">
                {{ forms.textField({
                    label: 'Price'|t('booked'),
                    id: 'price',
                    name: 'price',
                    type: 'number',
                    step: '0.01',
                    value: service.price,
                    errors: service.getErrors('price'),
                    instructions: 'Service price'|t('booked')
                }) }}
            </div>
        </div>

        <div class="flex" style="gap: 1rem; margin-top: 1.5rem;">
            <div style="flex: 1;">
                {{ forms.textField({
                    label: 'Buffer Before (minutes)'|t('booked'),
                    id: 'bufferBefore',
                    name: 'bufferBefore',
                    type: 'number',
                    value: service.bufferBefore,
                    errors: service.getErrors('bufferBefore'),
                    instructions: 'Buffer time before service starts'|t('booked')
                }) }}
            </div>

            <div style="flex: 1;">
                {{ forms.textField({
                    label: 'Buffer After (minutes)'|t('booked'),
                    id: 'bufferAfter',
                    name: 'bufferAfter',
                    type: 'number',
                    value: service.bufferAfter,
                    errors: service.getErrors('bufferAfter'),
                    instructions: 'Buffer time after service ends'|t('booked')
                }) }}
            </div>
        </div>

        {# Booking Configuration Section #}
        <hr>
        <h2>{{ 'Booking Configuration'|t('booked') }}</h2>

        <div class="flex" style="gap: 1rem;">
            <div style="flex: 1;">
                {{ forms.textField({
                    label: 'Minimum time before booking (minutes)'|t('booked'),
                    id: 'minTimeBeforeBooking',
                    name: 'minTimeBeforeBooking',
                    type: 'number',
                    min: 0,
                    value: service.minTimeBeforeBooking,
                    errors: service.getErrors('minTimeBeforeBooking'),
                    instructions: 'How late can appointments be booked? Leave empty to use default settings.'|t('booked'),
                    placeholder: 'Default'|t('booked')
                }) }}
            </div>

            <div style="flex: 1;">
                {{ forms.textField({
                    label: 'Minimum time before canceling (minutes)'|t('booked'),
                    id: 'minTimeBeforeCanceling',
                    name: 'minTimeBeforeCanceling',
                    type: 'number',
                    min: 0,
                    value: service.minTimeBeforeCanceling,
                    errors: service.getErrors('minTimeBeforeCanceling'),
                    instructions: 'How late can appointments be cancelled? Leave empty to use default settings.'|t('booked'),
                    placeholder: 'Default'|t('booked')
                }) }}
            </div>
        </div>

        {{ forms.textField({
            label: 'Final Step URL'|t('booked'),
            id: 'finalStepUrl',
            name: 'finalStepUrl',
            value: service.finalStepUrl,
            errors: service.getErrors('finalStepUrl'),
            instructions: 'URL to redirect after successful booking. Leave empty to show the default confirmation step.'|t('booked'),
            placeholder: 'https://...'
        }) }}

        {% set settings = craft.booked.getSettings() %}
        {% if settings.enableVirtualMeetings %}
            <hr>

            {{ forms.selectField({
                label: 'Virtual Meeting Provider'|t('booked'),
                id: 'virtualMeetingProvider',
                name: 'virtualMeetingProvider',
                options: [
                    { label: 'None'|t('booked'), value: '' },
                    { label: 'Zoom'|t('booked'), value: 'zoom' },
                    { label: 'Google Meet'|t('booked'), value: 'google_meet' }
                ],
                value: service.virtualMeetingProvider,
                errors: service.getErrors('virtualMeetingProvider'),
                instructions: 'Select the virtual meeting provider for this service.'|t('booked')
            }) }}
        {% endif %}

        {# Add-Ons #}
        <hr>
        <h2>{{ 'Add-Ons'|t('booked') }}</h2>

        {% if service.id %}
            {% set selectedExtras = craft.entries.section('serviceExtra').relatedTo(service).all() %}
            {# Fallback to service extra service for now until we migrate the data #}
            {% if not selectedExtras|length %}
                {% set selectedExtras = craft.booked.serviceExtra.getExtrasForService(service.id, false) %}
            {% endif %}
        {% else %}
            {% set selectedExtras = [] %}
        {% endif %}

        {{ forms.elementSelectField({
            label: 'Available Add-Ons'|t('booked'),
            instructions: 'Select which add-ons should be available for this service. Customers can add these when booking.'|t('booked'),
            id: 'extras',
            name: 'extras',
            elementType: 'fabian\\booked\\elements\\ServiceExtra',
            elements: selectedExtras,
            limit: null,
            showSiteMenu: false,
            sources: '*',
            criteria: {
                orderBy: 'title asc'
            }
        }) }}

        {# Custom Fields from Field Layout #}
        {% set fieldLayout = service.getFieldLayout() %}
        {% if fieldLayout and fieldLayout.getTabs()|length %}
            <hr>
            <h2>{{ 'Custom Fields'|t('booked') }}</h2>

            {% namespace 'fields' %}
                {% for tab in fieldLayout.getTabs() %}
                    {% for layoutElement in tab.getElements() %}
                        {% set formHtml = layoutElement.formHtml(service) %}
                        {% if formHtml %}
                            {{ formHtml|raw }}
                        {% endif %}
                    {% endfor %}
                {% endfor %}
            {% endnamespace %}
        {% endif %}
    </div>
{% endblock %}
