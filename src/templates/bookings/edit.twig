{% extends "_layouts/cp" %}

{% set title = reservation.id ? "Buchung bearbeiten #" ~ reservation.id : "Neue Buchung" %}
{% set crumbs = [
    { label: "Buchungen", url: url('booking/bookings') },
    { label: title }
] %}

{% block content %}
    <form method="post" accept-charset="UTF-8">
        {{ csrfInput() }}
        <input type="hidden" name="action" value="booking/bookings/save">
        {% if reservation.id %}
            <input type="hidden" name="id" value="{{ reservation.id }}">
        {% endif %}

        <div class="fields">
            <div class="field" id="userName-field">
                <div class="heading">
                    <label id="userName-label" for="userName" class="required">Name</label>
                </div>
                <div class="input">
                    <input class="text fullwidth" type="text" id="userName" name="userName" 
                           value="{{ reservation.userName }}" required>
                </div>
                {% if reservation.hasErrors('userName') %}
                    <ul class="errors">
                        {% for error in reservation.getErrors('userName') %}
                            <li>{{ error }}</li>
                        {% endfor %}
                    </ul>
                {% endif %}
            </div>

            <div class="field" id="userEmail-field">
                <div class="heading">
                    <label id="userEmail-label" for="userEmail" class="required">E-Mail</label>
                </div>
                <div class="input">
                    <input class="text fullwidth" type="email" id="userEmail" name="userEmail" 
                           value="{{ reservation.userEmail }}" required>
                </div>
                {% if reservation.hasErrors('userEmail') %}
                    <ul class="errors">
                        {% for error in reservation.getErrors('userEmail') %}
                            <li>{{ error }}</li>
                        {% endfor %}
                    </ul>
                {% endif %}
            </div>

            <div class="field" id="userPhone-field">
                <div class="heading">
                    <label id="userPhone-label" for="userPhone">Telefon</label>
                </div>
                <div class="input">
                    <input class="text fullwidth" type="tel" id="userPhone" name="userPhone" 
                           value="{{ reservation.userPhone }}">
                </div>
                {% if reservation.hasErrors('userPhone') %}
                    <ul class="errors">
                        {% for error in reservation.getErrors('userPhone') %}
                            <li>{{ error }}</li>
                        {% endfor %}
                    </ul>
                {% endif %}
            </div>

            <div class="field" id="bookingDate-field">
                <div class="heading">
                    <label id="bookingDate-label" for="bookingDate" class="required">Buchungsdatum</label>
                </div>
                <div class="input">
                    <input class="text fullwidth" type="date" id="bookingDate" name="bookingDate" 
                           value="{{ reservation.bookingDate }}" required>
                </div>
                {% if reservation.hasErrors('bookingDate') %}
                    <ul class="errors">
                        {% for error in reservation.getErrors('bookingDate') %}
                            <li>{{ error }}</li>
                        {% endfor %}
                    </ul>
                {% endif %}
            </div>

            <div class="flex">
                <div class="field" id="startTime-field">
                    <div class="heading">
                        <label id="startTime-label" for="startTime" class="required">Startzeit</label>
                    </div>
                    <div class="input">
                        <input class="text fullwidth" type="time" id="startTime" name="startTime" 
                               value="{{ reservation.startTime }}" required>
                    </div>
                    {% if reservation.hasErrors('startTime') %}
                        <ul class="errors">
                            {% for error in reservation.getErrors('startTime') %}
                                <li>{{ error }}</li>
                            {% endfor %}
                        </ul>
                    {% endif %}
                </div>

                <div class="field" id="endTime-field">
                    <div class="heading">
                        <label id="endTime-label" for="endTime" class="required">Endzeit</label>
                    </div>
                    <div class="input">
                        <input class="text fullwidth" type="time" id="endTime" name="endTime" 
                               value="{{ reservation.endTime }}" required>
                    </div>
                    {% if reservation.hasErrors('endTime') %}
                        <ul class="errors">
                            {% for error in reservation.getErrors('endTime') %}
                                <li>{{ error }}</li>
                            {% endfor %}
                        </ul>
                    {% endif %}
                </div>
            </div>

            <div class="field" id="quantity-field">
                <div class="heading">
                    <label id="quantity-label" for="quantity" class="required">Anzahl Plätze</label>
                </div>
                <div class="input">
                    <input class="text fullwidth" type="number" id="quantity" name="quantity"
                           value="{{ reservation.quantity ?? 1 }}" min="1" required>
                </div>
                <div class="instructions">
                    <p>Anzahl der gebuchten Plätze für diese Reservierung.</p>
                </div>
                {% if reservation.hasErrors('quantity') %}
                    <ul class="errors">
                        {% for error in reservation.getErrors('quantity') %}
                            <li>{{ error }}</li>
                        {% endfor %}
                    </ul>
                {% endif %}
            </div>

            {% if reservation.sourceType or variation %}
            {% if reservation.sourceType %}
            <div class="field">
                <div class="heading">
                    <label>Gebucht</label>
                </div>
                <div class="input">
                    {% if reservation.sourceType == 'entry' and reservation.sourceId %}
                        {% set sourceEntry = craft.entries.id(reservation.sourceId).one() %}
                        {% if sourceEntry %}
                            <a href="{{ sourceEntry.cpEditUrl }}" class="go">{{ sourceEntry.title }}</a>
                        {% else %}
                            <span class="light">{{ reservation.getSourceName() }}</span>
                        {% endif %}
                    {% else %}
                        <span class="light">{{ reservation.getSourceName() }}</span>
                    {% endif %}
                </div>
            </div>
            {% endif %}
            
            {% if variation %}
            <div class="field">
                <div class="heading">
                    <label>Variante</label>
                </div>
                <div class="input">
                    <a href="{{ cpUrl('booking/variations/edit/' ~ variation.id) }}" class="go">{{ variation.title }}</a>
                    {% if variation.description %}
                        <div class="instructions"><p>{{ variation.description }}</p></div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
            {% endif %}

            <div class="field" id="status-field">
                <div class="heading">
                    <label id="status-label" for="status" class="required">Status</label>
                </div>
                <div class="input">
                    <div class="select fullwidth">
                        <select id="status" name="status" required>
                            {% for value, label in statuses %}
                                <option value="{{ value }}" {{ reservation.status == value ? 'selected' : '' }}>{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                {% if reservation.hasErrors('status') %}
                    <ul class="errors">
                        {% for error in reservation.getErrors('status') %}
                            <li>{{ error }}</li>
                        {% endfor %}
                    </ul>
                {% endif %}
            </div>

            <div class="field" id="notes-field">
                <div class="heading">
                    <label id="notes-label" for="notes">Notizen</label>
                </div>
                <div class="input">
                    <textarea class="text fullwidth" id="notes" name="notes" rows="4">{{ reservation.notes }}</textarea>
                </div>
                {% if reservation.hasErrors('notes') %}
                    <ul class="errors">
                        {% for error in reservation.getErrors('notes') %}
                            <li>{{ error }}</li>
                        {% endfor %}
                    </ul>
                {% endif %}
            </div>
        </div>

        <div class="buttons">
            <button type="submit" class="btn submit">{{ reservation.id ? 'Aktualisieren' : 'Erstellen' }}</button>
            <a class="btn" href="{{ url('booking/bookings') }}">Abbrechen</a>
        </div>
    </form>
{% endblock %}

{% js %}
// Auto-calculate end time based on start time and default duration
document.getElementById('startTime').addEventListener('change', function() {
    const startTime = this.value;
    const endTimeField = document.getElementById('endTime');
    
    if (startTime && !endTimeField.value) {
        const start = new Date('2000-01-01 ' + startTime);
        start.setMinutes(start.getMinutes() + 60); // Default 60 minutes
        
        const hours = start.getHours().toString().padStart(2, '0');
        const minutes = start.getMinutes().toString().padStart(2, '0');
        endTimeField.value = hours + ':' + minutes;
    }
});
{% endjs %}
