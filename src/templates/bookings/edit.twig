{% extends "_layouts/cp" %}
{% import "_includes/forms" as forms %}

{% set title = reservation.id ? "Buchung bearbeiten #" ~ reservation.id : "Neue Buchung" %}
{% set crumbs = [
    { label: "Buchungen", url: url('booked/bookings') },
    { label: title }
] %}

{% set fullPageForm = true %}

{% block content %}
    <input type="hidden" name="action" value="booked/cp/bookings/save">
    {% if reservation.id %}
        <input type="hidden" name="id" value="{{ reservation.id }}">
    {% endif %}

    <div id="fields">
        {{ forms.textField({
            label: 'Name'|t('booked'),
            id: 'userName',
            name: 'userName',
            value: reservation.userName,
            required: true,
            errors: reservation.getErrors('userName')
        }) }}

        {{ forms.textField({
            label: 'E-Mail'|t('booked'),
            id: 'userEmail',
            name: 'userEmail',
            type: 'email',
            value: reservation.userEmail,
            required: true,
            errors: reservation.getErrors('userEmail')
        }) }}

        {{ forms.textField({
            label: 'Telefon'|t('booked'),
            id: 'userPhone',
            name: 'userPhone',
            value: reservation.userPhone,
            errors: reservation.getErrors('userPhone')
        }) }}

        {{ forms.dateField({
            label: 'Buchungsdatum'|t('booked'),
            id: 'bookingDate',
            name: 'bookingDate',
            value: reservation.bookingDate,
            required: true,
            errors: reservation.getErrors('bookingDate')
        }) }}

        <div class="flex">
            {{ forms.timeField({
                label: 'Startzeit'|t('booked'),
                id: 'startTime',
                name: 'startTime',
                value: reservation.startTime,
                required: true,
                errors: reservation.getErrors('startTime')
            }) }}

            {{ forms.timeField({
                label: 'Endzeit'|t('booked'),
                id: 'endTime',
                name: 'endTime',
                value: reservation.endTime,
                required: true,
                errors: reservation.getErrors('endTime')
            }) }}
        </div>

        {{ forms.textField({
            label: 'Anzahl Pl√§tze'|t('booked'),
            id: 'quantity',
            name: 'quantity',
            type: 'number',
            value: reservation.quantity ?? 1,
            min: 1,
            required: true,
            errors: reservation.getErrors('quantity')
        }) }}

        {{ forms.selectField({
            label: 'Status'|t('booked'),
            id: 'status',
            name: 'status',
            options: statuses,
            value: reservation.status,
            required: true,
            errors: reservation.getErrors('status')
        }) }}

        {{ forms.textareaField({
            label: 'Notizen'|t('booked'),
            id: 'notes',
            name: 'notes',
            value: reservation.notes,
            rows: 4,
            errors: reservation.getErrors('notes')
        }) }}

        {# Custom Fields #}
        {% set fieldLayout = reservation.getFieldLayout() %}
        {% if fieldLayout %}
            {% for tab in fieldLayout.getTabs() %}
                <hr>
                <h3>{{ tab.name|t('site') }}</h3>
                {{ tab.createForm(reservation).render()|raw }}
            {% endfor %}
        {% endif %}
    </div>
{% endblock %}

{% js %}
// Auto-calculate end time based on start time and default duration
document.getElementById('startTime').addEventListener('change', function() {
    const startTime = this.value;
    const endTimeField = document.getElementById('endTime');
    
    if (startTime && !endTimeField.value) {
        const start = new Date('2000-01-01 ' + startTime);
        start.setMinutes(start.getMinutes() + 60); // Default 60 minutes
        
        const hours = start.getHours().toString().padStart(2, '0');
        const minutes = start.getMinutes().toString().padStart(2, '0');
        endTimeField.value = hours + ':' + minutes;
    }
});
{% endjs %}
