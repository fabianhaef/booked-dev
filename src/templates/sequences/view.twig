{% extends "_layouts/cp" %}
{% set pluginHandle = 'booked' %}

{% set title = "Sequential Booking #" ~ sequence.id %}
{% set crumbs = [
    { label: "Sequential Bookings", url: url('booked/sequences') },
    { label: "Sequence #" ~ sequence.id }
] %}

{% block actionButton %}
    <div class="btngroup">
        {% if sequence.status == 'pending' %}
            <button type="button" class="btn submit" onclick="confirmSequence({{ sequence.id }})">Confirm All</button>
        {% endif %}
        {% if sequence.status != 'cancelled' %}
            <button type="button" class="btn" onclick="cancelSequence({{ sequence.id }})">Cancel All</button>
        {% endif %}
        <form method="post" style="display: inline;">
            {{ csrfInput() }}
            <input type="hidden" name="action" value="booked/sequences/delete">
            <input type="hidden" name="id" value="{{ sequence.id }}">
            <button type="submit" class="btn" onclick="return confirm('Delete this booking sequence?')">Delete</button>
        </form>
    </div>
{% endblock %}

{% block content %}
    <div class="sequence-details">
        <div class="pane">
            <div class="meta">
                <div class="data">
                    <h5 class="heading">Customer Information</h5>
                    <div class="value">
                        <strong>{{ sequence.customerName }}</strong><br>
                        <a href="mailto:{{ sequence.customerEmail }}">{{ sequence.customerEmail }}</a>
                    </div>
                </div>

                <div class="data">
                    <h5 class="heading">Sequence Summary</h5>
                    <div class="value">
                        Status: <span class="status {{ sequence.status }}">{{ sequence.status|title }}</span><br>
                        Total Services: {{ items|length }}<br>
                        Total Duration: {{ sequence.getTotalDuration() }} minutes<br>
                        Total Price: {{ sequence.totalPrice|number_format(2) }} CHF
                    </div>
                </div>

                <div class="data">
                    <h5 class="heading">Booking Information</h5>
                    <div class="value">
                        Created: {{ sequence.dateCreated|date('d.m.Y H:i') }}<br>
                        Updated: {{ sequence.dateUpdated|date('d.m.Y H:i') }}
                    </div>
                </div>
            </div>
        </div>

        <div class="pane">
            <h5 class="heading">Services in Sequence</h5>

            <table class="data fullwidth">
                <thead>
                    <tr>
                        <th>Order</th>
                        <th>Service</th>
                        <th>Date</th>
                        <th>Time</th>
                        <th>Duration</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in items %}
                        <tr>
                            <td>{{ item.sequenceOrder + 1 }}</td>
                            <td>
                                {% set service = item.getService() %}
                                {{ service ? service.title : 'N/A' }}
                            </td>
                            <td>{{ item.bookingDate|date('d.m.Y') }}</td>
                            <td>{{ item.startTime }} - {{ item.endTime }}</td>
                            <td>{{ item.durationMinutes }} min</td>
                            <td><span class="status {{ item.status }}">{{ item.status|title }}</span></td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>

            <hr>

            <div class="field">
                <form method="post" onsubmit="return confirm('Are you sure you want to delete this booking sequence? All reservations will also be deleted.')">
                    {{ csrfInput() }}
                    <input type="hidden" name="action" value="booked/sequences/delete">
                    <input type="hidden" name="id" value="{{ sequence.id }}">
                    <button type="submit" class="btn submit fullwidth">Delete Sequence</button>
                </form>
            </div>
        </div>
    </div>
{% endblock %}

{% css %}
.sequence-details {
    display: flex;
    gap: 24px;
}

.sequence-details .pane {
    flex: 1;
}

.sequence-details .pane:last-child {
    flex: 2;
}

.status {
    padding: 4px 8px;
    border-radius: 3px;
    font-size: 11px;
    font-weight: bold;
    text-transform: uppercase;
    display: inline-block;
}

.status.confirmed {
    background: #d4edda;
    color: #155724;
}

.status.pending {
    background: #fff3cd;
    color: #856404;
}

.status.cancelled {
    background: #f8d7da;
    color: #721c24;
}

.status.completed {
    background: #d1ecf1;
    color: #0c5460;
}

table.data {
    border-collapse: collapse;
    margin-top: 16px;
}

table.data th {
    background: #f5f5f5;
    font-weight: 600;
    text-align: left;
    padding: 8px 12px;
    border-bottom: 2px solid #ddd;
}

table.data td {
    padding: 8px 12px;
    border-bottom: 1px solid #eee;
}

table.data tr:hover {
    background: #fafafa;
}
{% endcss %}

{% js %}
function confirmSequence(id) {
    if (confirm('Confirm all bookings in this sequence?')) {
        Craft.postActionRequest('booked/sequences/confirm', { id: id }, function(response) {
            if (response.success) {
                Craft.cp.displayNotice(response.message);
                location.reload();
            } else {
                Craft.cp.displayError(response.message);
            }
        });
    }
}

function cancelSequence(id) {
    if (confirm('Cancel all bookings in this sequence?')) {
        Craft.postActionRequest('booked/sequences/cancel', { id: id }, function(response) {
            if (response.success) {
                Craft.cp.displayNotice(response.message);
                location.reload();
            } else {
                Craft.cp.displayError(response.message);
            }
        });
    }
}
{% endjs %}
