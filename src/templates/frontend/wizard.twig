{#
/**
 * Booked Wizard Template
 *
 * Flow:
 * Step 1: Select Service
 * Step 2: Select Location (skipped if only one)
 * Step 3: Select Employee (skipped if service has no employee-specific schedules)
 * Step 4: Select Date & Time
 * Step 5: Enter Customer Info
 * Step 6: Review & Confirm
 * Step 7: Success
 */
#}
{% do view.registerAssetBundle("fabian\\booked\\assetbundles\\BookedAsset") %}

<div class="booked-wizard" x-data="bookingWizard()" :class="{ 'booked-loading': loading }">
    <!-- Step Indicator -->
    <div class="booked-step-indicator">
        <div class="booked-step" :class="{ 'active': step >= 1 }">1. Service</div>
        <div class="booked-step" :class="{ 'active': step >= 2 }" x-show="locations.length > 1">2. Ort</div>
        <div class="booked-step" :class="{ 'active': step >= 3 }" x-show="!skipEmployeeStep && employees.length > 0">
            <span x-text="locations.length > 1 ? '3. Mitarbeiter' : '2. Mitarbeiter'"></span>
        </div>
        <div class="booked-step" :class="{ 'active': step >= 4 }">
            <span x-text="(locations.length > 1 ? 3 : 2) + (skipEmployeeStep ? 0 : 1) + '. Datum & Zeit'"></span>
        </div>
        <div class="booked-step" :class="{ 'active': step >= 5 }">
            <span x-text="(locations.length > 1 ? 4 : 3) + (skipEmployeeStep ? 0 : 1) + '. Info'"></span>
        </div>
        <div class="booked-step" :class="{ 'active': step >= 6 }">
            <span x-text="(locations.length > 1 ? 5 : 4) + (skipEmployeeStep ? 0 : 1) + '. Bestätigung'"></span>
        </div>
    </div>

    <!-- Step 1: Service Selection -->
    <div x-show="step === 1">
        <h3>Wählen Sie eine Dienstleistung</h3>
        <div class="booked-grid">
            <template x-for="service in services" :key="service.id">
                <div class="booked-card" @click="selectService(service)">
                    <h4 x-text="service.title"></h4>
                    <p x-text="service.description"></p>
                    <div class="light" x-text="service.duration + ' min | ' + service.price + ' CHF'"></div>
                </div>
            </template>
            <template x-if="services.length === 0 && !loading">
                <div class="booked-card booked-card-disabled">
                    <h4>Keine Services verfügbar</h4>
                    <p>Es sind derzeit keine buchbaren Services konfiguriert.</p>
                </div>
            </template>
        </div>
    </div>

    <!-- Step 2: Location Selection -->
    <div x-show="step === 2">
        <h3>Wählen Sie einen Standort</h3>
        <div class="booked-grid">
            <template x-for="location in locations" :key="location.id">
                <div class="booked-card" @click="selectLocation(location)">
                    <h4 x-text="location.name"></h4>
                    <p x-text="location.address"></p>
                </div>
            </template>
        </div>
        <button class="btn mt-4" @click="prevStep()">Zurück</button>
    </div>

    <!-- Step 3: Employee Selection -->
    <div x-show="step === 3">
        <h3>Wählen Sie einen Mitarbeiter</h3>
        <div class="booked-grid">
            <!-- No schedules configured at all -->
            <template x-if="!hasSchedules && !loading">
                <div class="booked-card booked-card-error">
                    <h4>Keine Termine verfügbar</h4>
                    <p>Für diesen Service wurden noch keine Verfügbarkeiten konfiguriert. Bitte kontaktieren Sie uns direkt.</p>
                </div>
            </template>

            <!-- Schedules exist but no employees (shouldn't happen if flow is correct, but safety net) -->
            <template x-if="hasSchedules && employees.length === 0 && !skipEmployeeStep && !loading">
                <div class="booked-card booked-card-disabled">
                    <h4>Keine Mitarbeiter verfügbar</h4>
                    <p>Aktuell sind keine Mitarbeiter für diesen Service verfügbar.</p>
                </div>
            </template>

            <!-- "Any available" option when employee is optional -->
            <template x-if="employees.length > 0 && !employeeRequired">
                <div class="booked-card booked-card-any" @click="skipEmployee()">
                    <h4>Beliebig</h4>
                    <p>Erster verfügbarer Mitarbeiter</p>
                </div>
            </template>

            <!-- Employee list -->
            <template x-for="employee in employees" :key="employee.id">
                <div class="booked-card" @click="selectEmployee(employee)">
                    <h4 x-text="employee.name"></h4>
                    <p x-text="employee.bio"></p>
                </div>
            </template>
        </div>
        <button class="btn mt-4" @click="prevStep()">Zurück</button>
    </div>

    <!-- Step 4: Date & Time Selection -->
    <div x-show="step === 4">
        <h3>Wählen Sie Datum und Zeit</h3>
        <div class="flex gap-8">
            <div class="w-1/2">
                <input type="date" x-model="date" @change="selectDate($event.target.value)" class="text-input">
            </div>
            <div class="w-1/2">
                <div class="booked-slots">
                    <template x-for="slot in availableSlots" :key="slot.time">
                        <div class="booked-slot" @click="selectSlot(slot)">
                            <span x-text="slot.time"></span>
                            <span x-show="slot.employeeName && !selectedEmployee" class="text-sm text-gray-500" x-text="'(' + slot.employeeName + ')'"></span>
                        </div>
                    </template>
                    <template x-if="availableSlots.length === 0 && date && !loading">
                        <p class="light">Keine freien Termine an diesem Tag.</p>
                    </template>
                </div>
            </div>
        </div>
        <button class="btn mt-4" @click="prevStep()">Zurück</button>
    </div>

    <!-- Step 5: Customer Information -->
    <div x-show="step === 5">
        <h3>Ihre Informationen</h3>
        <div class="form-group">
            <label>Name</label>
            <input type="text" x-model="customerName" class="text-input" required>
        </div>
        <div class="form-group">
            <label>E-Mail</label>
            <input type="email" x-model="customerEmail" class="text-input" required>
        </div>
        <div class="form-group">
            <label>Telefon</label>
            <input type="tel" x-model="customerPhone" class="text-input">
        </div>
        <div class="form-group">
            <label>Notizen</label>
            <textarea x-model="notes" class="text-input"></textarea>
        </div>
        <div class="flex justify-between mt-4">
            <button class="btn" @click="prevStep()">Zurück</button>
            <button class="btn btn-primary" @click="nextStep()" :disabled="!customerName || !customerEmail">Weiter</button>
        </div>
    </div>

    <!-- Step 6: Review and Confirm -->
    <div x-show="step === 6">
        <h3>Buchung bestätigen</h3>
        <div class="booked-summary p-4 bg-gray-50 rounded">
            <p><strong>Dienstleistung:</strong> <span x-text="selectedService?.title"></span></p>
            <p x-show="locations.length > 1"><strong>Ort:</strong> <span x-text="selectedLocation?.name"></span></p>
            <p x-show="selectedEmployee"><strong>Mitarbeiter:</strong> <span x-text="selectedEmployee?.name"></span></p>
            <p x-show="!selectedEmployee && employees.length > 0"><strong>Mitarbeiter:</strong> Erster Verfügbarer</p>
            <p><strong>Datum:</strong> <span x-text="date"></span></p>
            <p><strong>Zeit:</strong> <span x-text="time"></span></p>
            <hr class="my-2">
            <p><strong>Name:</strong> <span x-text="customerName"></span></p>
            <p><strong>E-Mail:</strong> <span x-text="customerEmail"></span></p>
        </div>
        <div class="flex justify-between mt-4">
            <button class="btn" @click="prevStep()">Zurück</button>
            <button class="btn btn-primary" @click="submitBooking()" :disabled="loading">
                <span x-show="!loading">Jetzt buchen</span>
                <span x-show="loading">Wird bearbeitet...</span>
            </button>
        </div>
    </div>

    <!-- Step 7: Success -->
    <div x-show="step === 7">
        <div class="booked-success text-center py-8">
            <svg class="mx-auto mb-4" width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: #10b981;">
                <circle cx="12" cy="12" r="10"></circle>
                <path d="m9 12 2 2 4-4"></path>
            </svg>

            <h3 class="text-2xl font-bold mb-2">Buchung erfolgreich!</h3>
            <p class="text-gray-600 mb-6">Ihre Buchung wurde erfolgreich erstellt.</p>

            <div class="booked-success-details p-6 bg-gray-50 rounded-lg mb-6 text-left max-w-md mx-auto">
                <p class="mb-2"><strong>Status:</strong> <span x-text="reservationDetails?.status || 'Bestätigt'"></span></p>
                <p class="mb-2"><strong>Buchungs-ID:</strong> #<span x-text="reservationDetails?.id"></span></p>
                <p class="mb-4"><strong>Termin:</strong> <span x-text="reservationDetails?.formattedDateTime || (date + ' um ' + time)"></span></p>

                <div class="bg-blue-50 border-l-4 border-blue-500 p-4 text-sm">
                    <p class="font-semibold text-blue-900 mb-1">Nächste Schritte:</p>
                    <p class="text-blue-800">Sie erhalten in Kürze eine Bestätigungs-E-Mail an <strong x-text="customerEmail"></strong> mit allen Details zu Ihrer Buchung.</p>
                </div>
            </div>

            <div class="flex gap-4 justify-center">
                <button class="btn btn-primary" @click="resetWizard()">Neue Buchung erstellen</button>
                <a href="/" class="btn">Zur Startseite</a>
            </div>
        </div>
    </div>
</div>

{% js %}
    window.csrfTokenName = "{{ craft.app.config.general.csrfTokenName }}";
    window.csrfTokenValue = "{{ craft.app.request.csrfToken }}";
{% endjs %}
